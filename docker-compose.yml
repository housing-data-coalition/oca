version: '3'

services:
  app:
    build: 
      context: .
      dockerfile: Dockerfile
      args: 
        SFTP_HOST: ${SFTP_HOST}
        MODE: ${MODE}
    user: 'root'
    volumes:
      - .:/app
    depends_on: 
      db:
        condition: service_healthy
    links:
      - db
  db:
    image: postgres:15.3-alpine
    environment:
      - POSTGRES_DB=oca
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=oca
    ports:
      - 5432:5432
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB" ]
      timeout: 5s
      interval: 1s
      retries: 20
    command:
      # See https://osm2pgsql.org/doc/manual.html#tuning-the-postgresql-server
      - "postgres"
      - "-c"
      - "shared_buffers=256MB"
      - "-c"
      - "work_mem=25MB"
      - "-c"
      - "maintenance_work_mem=128MB"
      - "-c"
      - "wal_level=minimal"
      - "-c"
      - "max_wal_size=4GB"
      - "-c"
      - "checkpoint_completion_target=0.9"
      - "-c"
      - "max_wal_senders=0"
      - "-c"
      - "random_page_cost=1.0"
      - "-c"
      - "checkpoint_timeout=30min"